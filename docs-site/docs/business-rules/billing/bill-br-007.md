---
id: "bill-br-007"
title: "Daily transaction report generation for billing reconciliation"
domain: "billing"
cobol_source: "CBTRN03C.cbl:93-113"
requirement_id: "BILL-BR-007"
regulations:
  - "FSA FFFS 2014:5 Ch. 7"
  - "AML 2017:11"
  - "DORA Art. 11"
status: "extracted"
validated_by: null
validated_date: null
priority: "medium"
---

# BILL-BR-007: Daily transaction report generation for billing reconciliation

## Summary

The billing reconciliation process relies on the daily transaction detail report generated by `CBTRN03C.cbl`, the third program in the batch processing pipeline. This report reads all posted transactions from the TRANSACT file and produces a formatted report with page headers, detail lines, page totals, account totals, and grand totals. The report structure supports billing reconciliation by providing a verifiable summary of all transactions processed in a billing period, organized by account with running totals. The report uses transaction type and category descriptions from lookup files (TRANTYPE and TRANCATG) to provide human-readable billing line items. Referenced from `CBTRN03C.cbl` (program structure) and report layouts from `CVTRA07Y.cpy`.

## Business Logic

### Pseudocode

```
REPORT GENERATION PIPELINE:
    Open files:
        TRANSACT (input) - posted transactions
        TRANTYPE (input) - transaction type descriptions
        TRANCATG (input) - transaction category descriptions
        TRANREPT (output) - report file

    PERFORM UNTIL end-of-TRANSACT:
        READ next TRANSACT record (ordered by TRAN-ID)

        Look up TRAN-TYPE-DESC from TRANTYPE file
        Look up TRAN-CAT-TYPE-DESC from TRANCATG file

        Format detail line:
            TRAN-ID | TRAN-TYPE-CD | TRAN-TYPE-DESC | TRAN-CAT-CD |
            TRAN-CAT-TYPE-DESC | TRAN-SOURCE | TRAN-AMT-DISPLAY

        WRITE detail line to TRANREPT

        Accumulate page total:
            ADD TRAN-AMT TO page-total
        Accumulate account total:
            ADD TRAN-AMT TO account-total
        Accumulate grand total:
            ADD TRAN-AMT TO grand-total

        IF page-full (lines per page exceeded):
            WRITE page-total line
            Start new page with headers
        END-IF

        IF account-break (new account detected):
            WRITE account-total line
            Reset account-total
        END-IF
    END-PERFORM

    WRITE grand-total line
    Close all files

REPORT LAYOUT STRUCTURES (from CVTRA07Y.cpy):
    REPORT-NAME-HEADER:    Report title with date range (115 chars)
    TRANSACTION-HEADER-1:  Column labels (114 chars)
    TRANSACTION-HEADER-2:  Separator line (133 chars)
    TRANSACTION-DETAIL:    Detail line (133 chars)
    REPORT-PAGE-TOTALS:    Page total line (111 chars)
    REPORT-ACCOUNT-TOTALS: Account total line (111 chars)
    REPORT-GRAND-TOTALS:   Grand total line (111 chars)
```

### Report Structure

| Section | Width | Content |
|---|---|---|
| Report Header | 115 chars | Report name, date range |
| Column Header | 114 chars | Transaction ID, Type, Category, Source, Amount |
| Separator | 133 chars | Dashes |
| Detail Line | 133 chars | Individual transaction data |
| Page Total | 111 chars | Sum of amounts on current page |
| Account Total | 111 chars | Sum of amounts for current account |
| Grand Total | 111 chars | Sum of all amounts in report |

### Lookup Tables

| File | Key | Description Field | Purpose |
|---|---|---|---|
| TRANTYPE | TRAN-TYPE (2 bytes) | TRAN-TYPE-DESC (50 bytes) | Human-readable transaction type names for billing line items |
| TRANCATG | TYPE-CD + CAT-CD (6 bytes) | TRAN-CAT-TYPE-DESC (50 bytes) | Human-readable category names for billing line items |

## Source COBOL Reference

**Program:** `CBTRN03C.cbl`
**Lines:** 93-113 (file references and copybook includes)

The program uses these copybooks for report structure:
- Line 93: `COPY CVTRA05Y.` — Posted transaction record (350 bytes)
- Line 103: `COPY CVTRA03Y.` — Transaction type description record (60 bytes)
- Line 108: `COPY CVTRA04Y.` — Transaction category description record (60 bytes)
- Line 113: `COPY CVTRA07Y.` — Report layout structures

**Report layout copybook:** `CVTRA07Y.cpy`

```
Report structures (from TRN-BR-007 extraction):
    REPORT-NAME-HEADER:         115 chars — report title with date range
    TRANSACTION-DETAIL-REPORT:  133 chars — detail line with all fields
    TRANSACTION-HEADER-1:       114 chars — column labels
    TRANSACTION-HEADER-2:       133 chars — separator line (all dashes)
    REPORT-PAGE-TOTALS:         111 chars — page total line
    REPORT-ACCOUNT-TOTALS:      111 chars — account total line
    REPORT-GRAND-TOTALS:        111 chars — grand total line
```

### Report File Organization

| Attribute | Value |
|---|---|
| File | TRANREPT |
| Record Length | 133 bytes |
| Access Method | Sequential (write-only) |
| Open Mode | OUTPUT |
| Contents | Formatted report lines (headers, details, totals) |

## Acceptance Criteria

### Scenario 1: Report includes all posted transactions

```gherkin
GIVEN the TRANSACT file contains 50 posted transactions
WHEN the report generation batch runs
THEN the report contains 50 detail lines
  AND a grand total line with the sum of all 50 amounts
```

### Scenario 2: Transaction type descriptions are resolved

```gherkin
GIVEN a transaction with TRAN-TYPE-CD = "01"
  AND the TRANTYPE file maps "01" to "PURCHASE"
WHEN the report detail line is generated
THEN the type description column shows "PURCHASE"
```

### Scenario 3: Transaction category descriptions are resolved

```gherkin
GIVEN a transaction with TYPE-CD = "01" and CAT-CD = "0001"
  AND the TRANCATG file maps "01"+"0001" to "RETAIL PURCHASE"
WHEN the report detail line is generated
THEN the category description column shows "RETAIL PURCHASE"
```

### Scenario 4: Account totals are calculated on account breaks

```gherkin
GIVEN transactions for account "12345678901" totaling 1500.00
  AND transactions for account "98765432109" totaling 750.00
WHEN the report is generated
THEN an account total line of 1500.00 appears after account "12345678901" transactions
  AND an account total line of 750.00 appears after account "98765432109" transactions
  AND the grand total is 2250.00
```

### Scenario 5: Page totals on page boundaries

```gherkin
GIVEN more transactions than fit on one report page
WHEN a page boundary is reached
THEN a page total line is written
  AND a new page starts with report and column headers
```

### Scenario 6: Amount formatting for report

```gherkin
GIVEN a transaction amount stored as S9(09)V99
WHEN the amount is formatted for the report
THEN it displays with a sign indicator and 2 decimal places
  AND the format preserves financial precision
```

## Regulatory Mapping

| Regulation | Article/Section | Requirement | How This Rule Satisfies It |
|---|---|---|---|
| FSA FFFS 2014:5 | Ch. 7 | Financial institutions must produce accurate financial reports | The transaction report provides a reconcilable summary of all posted transactions with account-level and grand totals |
| AML 2017:11 | Para. 3 | Transaction records must be available for anti-money-laundering review | The report provides a reviewable format for all transactions including type and category classifications |
| DORA | Art. 11 | ICT risk management — reporting and audit trail | The report generation is part of the daily batch pipeline, providing evidence of complete transaction processing |

## Edge Cases

1. **Missing type or category description**: If a transaction's type code or category code is not found in the lookup files, the description fields may be blank or contain the last-read value. The migrated system should handle missing lookups explicitly (e.g., "UNKNOWN TYPE").

2. **Account ordering**: The report groups transactions by account. If the TRANSACT file is not ordered by account, the account totals may not be meaningful. The migrated system should sort by account before generating account-level totals.

3. **Report file size**: For high-volume days, the sequential report file could be very large. The migrated system should consider paginated or on-demand report generation rather than writing a monolithic file.

4. **Amount total overflow**: The grand total accumulates all transaction amounts. For daily volumes of millions of transactions, the total could exceed the working storage field precision. The migrated system should use `decimal(18,2)` or similar for accumulator fields.

5. **Report as billing artifact**: This report serves as a source document for billing reconciliation. The migrated system should store the report data in a queryable format (database table) in addition to or instead of a flat file, enabling self-service billing inquiries.

## Domain Expert Notes

- **null** (null): Awaiting domain expert review. QUESTIONS: (1) Is this report used as the primary billing reconciliation artifact, or is there a separate billing report? (2) What is the expected daily transaction volume for report sizing? (3) Are the transaction type and category code tables static or do they change? (4) Should the migrated system generate PDF reports, or is a database-backed reporting UI preferred? (5) Are account totals based on the card account or the customer account?

---

**Template version:** 1.0
**Last updated:** 2026-02-16
