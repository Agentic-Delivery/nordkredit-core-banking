---
id: "rpt-br-010"
title: "Report data reconciliation and integrity validation"
domain: "reporting"
cobol_source: "CBTRN03C.cbl:287-322 (multi-level totaling), CBTRN02C.cbl:230-232 (return code and reject tracking)"
requirement_id: "RPT-BR-010"
regulations:
  - "FSA FFFS 2014:5 Ch. 3"
  - "FSA FFFS 2014:5 Ch. 7"
  - "DORA Art. 11"
status: "extracted"
validated_by: null
validated_date: null
priority: "critical"
---

# RPT-BR-010: Report data reconciliation and integrity validation

## Summary

All reports generated by NordKredit AB's batch pipeline must be internally consistent and reconcilable to source data. The CBTRN03C daily transaction report implements a three-level totaling hierarchy (page totals, account totals, grand total) where `Grand Total = Sum(Page Totals)` and `Account Total = Sum(detail amounts for that account)`. This deterministic totaling pattern is the foundation for cross-report reconciliation: the daily report grand total must match the sum of posted transactions in CBTRN02C, the monthly statement totals must reconcile to daily report totals for that period, and quarterly FSA reports must reconcile to the sum of monthly data. Extracted from the CBTRN03C multi-level totaling logic (lines 287-322) and FSA requirements for accurate financial records.

## Business Logic

### Pseudocode

```
REPORT RECONCILIATION FRAMEWORK:

    LEVEL 1 — INTRA-REPORT RECONCILIATION:
        Within the daily transaction report (CBTRN03C):
            Verify: Grand Total = Sum of all Page Totals
            Verify: Sum of all Account Totals = Grand Total
            Verify: Each Page Total = Sum of detail amounts on that page
            Verify: Each Account Total = Sum of detail amounts for that account

        COBOL implementation (CBTRN03C):
            WS-PAGE-TOTAL accumulates per page (reset every 20 lines)
            WS-ACCOUNT-TOTAL accumulates per card (reset on card change)
            WS-GRAND-TOTAL accumulates page totals
            At EOF: final page total + final account total + grand total written

    LEVEL 2 — CROSS-REPORT DAILY RECONCILIATION:
        After nightly batch completes:
            1. Transaction count check:
               CBTRN03C detail line count
               = CBTRN02C processed count - CBTRN02C reject count
               (posted transactions only appear in report)

            2. Amount reconciliation:
               CBTRN03C grand total
               = Sum of TRAN-AMT for all transactions in date range
               = Net posting amount from CBTRN02C

            3. AML screening reconciliation:
               AML screened transaction count (RPT-BR-002)
               = CBTRN03C detail line count
               (all posted transactions are screened)

            4. Management report reconciliation:
               Daily operations summary transaction count (RPT-BR-005)
               = CBTRN02C total processed count
               Portfolio balance change
               = CBTRN03C grand total (net of credits and debits)

    LEVEL 3 — PERIODIC RECONCILIATION:
        Monthly:
            Sum of daily report grand totals for month
            = Monthly statement transaction totals for all accounts
            = Monthly management report aggregate

        Quarterly:
            Sum of monthly totals for quarter
            = FSA quarterly report data extract totals

        Annually:
            Sum of quarterly totals for year
            = FSA annual report data extract totals
            = Year-end financial statement extract

    RECONCILIATION BREAK HANDLING:
        IF any reconciliation check fails:
            1. Log discrepancy with:
               - Report IDs being compared
               - Expected vs actual values
               - Difference amount
               - Timestamp of detection
            2. Classify severity:
               IF difference < 0.01 SEK: Rounding variance (log only)
               IF difference < 100 SEK: Minor (investigate within 24 hours)
               IF difference >= 100 SEK: Material (immediate investigation)
               IF difference involves missing records: Critical (halt reporting)
            3. Prevent downstream report generation until resolved
               (FSA reports must not be submitted with unreconciled data)

    HASH-BASED INTEGRITY:
        FOR EACH generated report:
            Calculate SHA-256 hash of report content
            Store hash with report metadata
            Verify hash on any subsequent access
            IF hash mismatch: report has been tampered with
                Raise integrity alert
                Block report from use until investigated
```

### Reconciliation Matrix

| Check | Source A | Source B | Frequency | Tolerance |
|---|---|---|---|---|
| Daily transaction count | CBTRN03C detail lines | CBTRN02C posted count | Daily | Exact match |
| Daily amount total | CBTRN03C grand total | Sum(TRANSACT amounts in range) | Daily | 0.00 SEK (exact) |
| Daily AML coverage | AML screened count | CBTRN03C detail count | Daily | Exact match |
| Monthly statement totals | Sum(daily grand totals) | Sum(statement account totals) | Monthly | 0.00 SEK (exact) |
| Quarterly FSA totals | Sum(monthly totals) | FSA quarterly extract totals | Quarterly | 0.00 SEK (exact) |
| Annual FSA totals | Sum(quarterly totals) | FSA annual extract totals | Annually | 0.00 SEK (exact) |
| Report integrity | Stored hash | Recalculated hash | On access | Exact match |

### Decision Table — Reconciliation Break Response

| Discrepancy Type | Amount | Impact | Response |
|---|---|---|---|
| Rounding variance | &lt; 0.01 SEK | None | Log, no action |
| Amount mismatch | &lt; 100 SEK | Minor | Investigate within 24 hours |
| Amount mismatch | >= 100 SEK | Material | Immediate investigation, block downstream |
| Count mismatch | Any | Material | Immediate investigation, block downstream |
| Missing records | Any | Critical | Halt all reporting, incident report (RPT-BR-006) |
| Hash mismatch | N/A | Critical | Integrity alert, block report, forensic investigation |

## Source COBOL Reference

**Program:** `CBTRN03C.cbl` (650 lines)

Multi-level totaling (the reconciliation baseline):

Page total accumulation (line 287-289):
```cobol
000287           ADD TRAN-AMT TO WS-PAGE-TOTAL
000288                           WS-ACCOUNT-TOTAL
000289           PERFORM 1120-WRITE-DETAIL
```

Page total rollup to grand total (lines 293-298):
```cobol
000293       1110-WRITE-PAGE-TOTALS.
000294           MOVE WS-PAGE-TOTAL TO REPT-PAGE-TOTAL
000295           MOVE REPORT-PAGE-TOTALS TO FD-REPTFILE-REC
000296           PERFORM 1111-WRITE-REPORT-REC
000297           ADD WS-PAGE-TOTAL TO WS-GRAND-TOTAL
000298           MOVE 0 TO WS-PAGE-TOTAL
```

Account total reset on card change (lines 306-310):
```cobol
000306       1120-WRITE-ACCOUNT-TOTALS.
000307           MOVE WS-ACCOUNT-TOTAL   TO REPT-ACCOUNT-TOTAL
000308           MOVE REPORT-ACCOUNT-TOTALS TO FD-REPTFILE-REC
000309           PERFORM 1111-WRITE-REPORT-REC
000310           MOVE 0 TO WS-ACCOUNT-TOTAL
```

Grand total write (lines 318-322):
```cobol
000318       1110-WRITE-GRAND-TOTALS.
000319           MOVE WS-GRAND-TOTAL TO REPT-GRAND-TOTAL
000320           MOVE REPORT-GRAND-TOTALS TO FD-REPTFILE-REC
000321           PERFORM 1111-WRITE-REPORT-REC
```

The arithmetic identity `Grand Total = Sum(Page Totals)` is guaranteed by the fixed-point `ADD` instruction at line 297. The COBOL `S9(09)V99` data type ensures no rounding — all additions are exact to 2 decimal places.

CBTRN02C reject tracking feeds into reconciliation (lines 230-232):
```cobol
000230           IF WS-REJECT-COUNT > 0
000231              MOVE 4 TO RETURN-CODE
000232           END-IF
```

The reject count from CBTRN02C is the key reconciliation input: `CBTRN03C detail count = CBTRN02C total processed - CBTRN02C reject count`.

## Acceptance Criteria

### Scenario 1: Intra-report total consistency

```gherkin
GIVEN the daily transaction report is generated with 150 transactions
  AND the report spans 8 pages (7 full pages of 20 + 1 partial page of 10)
WHEN the report is validated
THEN Grand Total = Sum of all 8 Page Totals
  AND Sum of all Account Totals = Grand Total
  AND the totaling uses fixed-point arithmetic (no rounding)
```

### Scenario 2: Cross-report daily amount reconciliation

```gherkin
GIVEN CBTRN02C posted 15,234 transactions with 127 rejects
  AND the CBTRN03C report was generated for the same date
WHEN daily reconciliation runs
THEN the CBTRN03C detail line count = 15,107 (15,234 - 127)
  AND the CBTRN03C grand total matches the sum of TRANSACT amounts in date range
  AND the reconciliation result is logged with both source values
```

### Scenario 3: Monthly cross-report reconciliation

```gherkin
GIVEN daily reports were generated for each day of January 2026
  AND customer statements were generated for January 2026
WHEN monthly reconciliation runs
THEN Sum(daily report grand totals for January) = Sum(statement transaction totals)
  AND any discrepancy triggers investigation per severity classification
```

### Scenario 4: Reconciliation break blocks downstream reporting

```gherkin
GIVEN a material discrepancy (>= 100 SEK) is detected between daily report and posting totals
WHEN the quarterly FSA report generation is triggered
THEN the FSA report generation is blocked until the discrepancy is resolved
  AND the compliance team is notified of the reconciliation break
  AND the investigation deadline is logged
```

### Scenario 5: Report integrity hash validation

```gherkin
GIVEN a daily report was generated with SHA-256 hash "abc123..."
  AND the hash was stored in report metadata
WHEN the report is accessed for a regulatory audit
THEN the stored hash is compared against a recalculated hash of the report content
  AND if hashes match, the report is confirmed as unmodified
  AND if hashes differ, an integrity alert is raised and the report is blocked
```

### Scenario 6: Rounding variance tolerance

```gherkin
GIVEN a monthly reconciliation detects a 0.005 SEK discrepancy
  AND the discrepancy falls below the 0.01 SEK rounding variance threshold
WHEN the reconciliation result is evaluated
THEN the variance is logged but no investigation is triggered
  AND the reconciliation is marked as passed with a rounding note
```

## Regulatory Mapping

| Regulation | Article/Section | Requirement | How This Rule Satisfies It |
|---|---|---|---|
| FSA FFFS 2014:5 | Ch. 3 | Accounting records must be accurate and complete | Multi-level reconciliation ensures report totals are arithmetically consistent and traceable to source data |
| FSA FFFS 2014:5 | Ch. 7 | Financial reporting systems must produce reliable output | Cross-report reconciliation validates that all reports derive from the same source data |
| DORA | Art. 11 | ICT risk management including data integrity monitoring | Hash-based integrity checks detect unauthorized modification of report files |

## Edge Cases

1. **Precision boundaries**: The COBOL `S9(09)V99` field supports amounts up to 999,999,999.99. If a grand total approaches this limit (unlikely for daily reports but possible for annual aggregates), the fixed-point addition may overflow. The migrated system using `decimal(11,2)` has the same range — consider using `decimal(18,2)` for aggregate totals.

2. **Report regeneration**: If a daily report is regenerated (e.g., after fixing a data quality issue), the reconciliation baseline must be updated to reflect the new report. The original report and its reconciliation record should be preserved for audit, and the regenerated report should be linked to the original.

3. **Timezone effects on date boundaries**: The date-range filter (CBTRN03C:173-178) uses `TRAN-PROC-TS(1:10)` — the first 10 characters of the processing timestamp. If the mainframe uses local time (CET/CEST) and the migrated system uses UTC, the same transaction may fall in different date ranges. The reconciliation must use consistent date handling.

4. **Partial batch recovery**: If CBTRN02C ABENDs mid-run and is restarted, some transactions may be processed twice (if not idempotent). The reconciliation should detect duplicate transaction IDs and flag them as potential double-posting.

5. **Cross-domain reconciliation**: The daily report totals should reconcile with changes in account balances (Account Management domain) and billing cycle accumulators (Billing domain). This requires cross-domain reconciliation that spans multiple batch programs and data stores.

## Domain Expert Notes

- **null** (null): Awaiting domain expert review. CRITICAL QUESTIONS: (1) Is there an existing reconciliation process between CBTRN03C output and CBTRN02C posting totals? (2) What is the current process when a reconciliation break is detected? (3) Are monthly/quarterly/annual report totals currently validated against daily report aggregates? (4) Is there an existing integrity check mechanism for report files (checksums, hash values)? (5) What tolerance thresholds are used for reconciliation in the current system? (6) How are reconciliation breaks escalated — to the operations team, compliance, or both?

---

**Template version:** 1.0
**Last updated:** 2026-02-17
