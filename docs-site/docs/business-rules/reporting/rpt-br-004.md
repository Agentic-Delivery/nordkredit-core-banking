---
id: "rpt-br-004"
title: "Daily transaction detail report generation"
domain: "reporting"
cobol_source: "CBTRN03C.cbl:158-374"
requirement_id: "RPT-BR-004"
regulations:
  - "FSA FFFS 2014:5 Ch. 7"
  - "AML 2017:11 Para. 3"
  - "DORA Art. 11"
status: "extracted"
validated_by: null
validated_date: null
priority: "high"
---

# RPT-BR-004: Daily transaction detail report generation

## Summary

The daily transaction detail report is the core operational report generated by the batch pipeline's step 3 (CBTRN03C). It reads all posted transactions from the TRANSACT file, filters by a date range from the DATEPARM parameter file, enriches each transaction with type and category descriptions from lookup files, and produces a formatted 133-column report grouped by card/account with page totals (every 20 lines), account totals (on card-number change), and a grand total. This report serves as the daily audit trail for compliance officers and operations staff, and its output feeds into higher-level regulatory reports (RPT-BR-001, RPT-BR-002). This rule captures the reporting-domain perspective of the report; the transaction-domain extraction is at TRN-BR-006. Extracted from `CBTRN03C.cbl`.

## Business Logic

### Pseudocode

```
DAILY TRANSACTION DETAIL REPORT (CBTRN03C):

    OPEN FILES:
        TRANSACT  (input, sequential)  - posted transactions
        REPORT    (output, sequential) - report output (133-char records)
        CARDXREF  (input, indexed)     - card-to-account cross-reference
        TRANTYPE  (input, indexed)     - transaction type descriptions
        TRANCATG  (input, indexed)     - category descriptions
        DATEPARM  (input, sequential)  - date range "YYYY-MM-DD YYYY-MM-DD"

    READ date parameters:
        WS-START-DATE = first 10 chars
        WS-END-DATE   = chars 12-21

    INITIALIZE:
        WS-PAGE-TOTAL    = 0  (S9(09)V99)
        WS-ACCOUNT-TOTAL = 0  (S9(09)V99)
        WS-GRAND-TOTAL   = 0  (S9(09)V99)
        WS-LINE-COUNT    = 0
        WS-PAGE-SIZE     = 20 (COMP-3)
        WS-FIRST-RECORD  = 'Y'

    FOR EACH transaction record (sequential read):
        IF TRAN-PROC-TS(1:10) < WS-START-DATE
           OR TRAN-PROC-TS(1:10) > WS-END-DATE
            SKIP record (date outside range)
            CONTINUE to next record
        END-IF

        IF card number changed from previous:
            IF NOT first record:
                WRITE account total for previous card
                RESET WS-ACCOUNT-TOTAL = 0
            END-IF
            LOOK UP card in CARDXREF -> get XREF-ACCT-ID
            IF lookup fails: ABEND 999
        END-IF

        LOOK UP transaction type in TRANTYPE -> get description
        IF lookup fails: ABEND 999

        LOOK UP transaction category in TRANCATG -> get description
        IF lookup fails: ABEND 999

        IF WS-FIRST-RECORD = 'Y':
            WRITE report header (name, date range)
            WRITE column headers
            WRITE separator line
            SET WS-FIRST-RECORD = 'N'
        END-IF

        IF WS-LINE-COUNT >= WS-PAGE-SIZE (20):
            WRITE page total
            ADD WS-PAGE-TOTAL TO WS-GRAND-TOTAL
            RESET WS-PAGE-TOTAL = 0
            RESET WS-LINE-COUNT = 0
            WRITE new page header
        END-IF

        ADD TRAN-AMT TO WS-PAGE-TOTAL
        ADD TRAN-AMT TO WS-ACCOUNT-TOTAL
        WRITE detail line (ID, account, type+desc, category+desc, source, amount)
        ADD 1 TO WS-LINE-COUNT
    END-FOR

    AT END-OF-FILE:
        WRITE final page total
        ADD WS-PAGE-TOTAL TO WS-GRAND-TOTAL
        WRITE final account total
        WRITE grand total

    CLOSE all files
    GOBACK
```

### Report Line Structure (133-column)

| Line Type | COBOL Structure | Width | Content |
|---|---|---|---|
| Report header | REPORT-NAME-HEADER | 115 | "DALYREPT" + "Daily Transaction Report" + date range |
| Column headers | TRANSACTION-HEADER-1 | 114 | Column labels |
| Separator | TRANSACTION-HEADER-2 | 133 | Dashes |
| Detail | TRANSACTION-DETAIL-REPORT | 133 | ID + Account + Type + Category + Source + Amount |
| Page total | REPORT-PAGE-TOTALS | 111 | "Page Total" + dotted leader + amount |
| Account total | REPORT-ACCOUNT-TOTALS | 111 | "Account Total" + dotted leader + amount |
| Grand total | REPORT-GRAND-TOTALS | 111 | "Grand Total" + dotted leader + amount |

### Amount Formatting

| Context | COBOL PIC | Sign | Example |
|---|---|---|---|
| Detail line | -ZZZ,ZZZ,ZZZ.ZZ | Negative (debit) | -125.50 |
| Page total | +ZZZ,ZZZ,ZZZ.ZZ | Signed | +12,345.67 |
| Account total | +ZZZ,ZZZ,ZZZ.ZZ | Signed | +50,000.00 |
| Grand total | +ZZZ,ZZZ,ZZZ.ZZ | Signed | +1,234,567.89 |

### Totaling Hierarchy

```
Grand Total = Sum of all Page Totals
Page Total  = Sum of Detail Amounts on current page (resets every 20 lines)
Account Total = Sum of Detail Amounts for current card/account (resets on card change)
```

**Precision:** All total fields use `S9(09)V99` — signed, 9 integer digits, 2 decimal places. Fixed-point addition only, no rounding. Maps to `decimal(11,2)` in .NET.

### File Dependencies

| File | Organization | Access | Key | Purpose |
|---|---|---|---|---|
| TRANSACT | Sequential | Sequential read | N/A | Posted transactions (input) |
| TRANREPT | Sequential | Sequential write | N/A | Report output |
| CARDXREF | Indexed (KSDS) | Random read | Card number X(16) | Card-to-account cross-reference |
| TRANTYPE | Indexed (KSDS) | Random read | Type code X(02) | Transaction type descriptions |
| TRANCATG | Indexed (KSDS) | Random read | Type+Category X(02)+9(04) | Category descriptions |
| DATEPARM | Sequential | Sequential read | N/A | Date range parameters |

## Source COBOL Reference

**Program:** `CBTRN03C.cbl` (650 lines)
**Key sections:**
- Lines 155-161: File OPEN
- Lines 158-217: Main processing loop with card-change detection
- Lines 173-178: Date-range filtering
- Lines 220-243: Date parameter read (0550-DATEPARM-READ)
- Lines 248-272: Transaction record read
- Lines 274-290: Write report entry with page-size check
- Lines 287-289: Amount accumulation into page and account totals
- Lines 293-304: Page total write
- Lines 306-316: Account total write
- Lines 318-322: Grand total write
- Lines 324-341: Header write
- Lines 361-374: Detail line write

```cobol
000173                IF TRAN-PROC-TS (1:10) >= WS-START-DATE
000174                   AND TRAN-PROC-TS (1:10) <= WS-END-DATE
000175                   CONTINUE
000176                ELSE
000177                   NEXT SENTENCE
000178                END-IF
```

```cobol
000287           ADD TRAN-AMT TO WS-PAGE-TOTAL
000288                           WS-ACCOUNT-TOTAL
000289           PERFORM 1120-WRITE-DETAIL
```

```cobol
000318       1300-WRITE-GRAND-TOTALS.
000319           MOVE WS-GRAND-TOTAL TO GRAND-TOTAL-AMT
000320           WRITE FD-REPTFILE-REC FROM REPORT-GRAND-TOTALS
000321                 AFTER ADVANCING 2 LINES
000322           INITIALIZE REPORT-GRAND-TOTALS
```

```cobol
000361       1120-WRITE-DETAIL.
000362           INITIALIZE TRANSACTION-DETAIL-REPORT
000363           MOVE TRAN-ID TO TRAN-REPORT-TRANS-ID
000364           MOVE XREF-ACCT-ID TO TRAN-REPORT-ACCOUNT-ID
000365           MOVE TRAN-TYPE-CD OF TRAN-RECORD TO TRAN-REPORT-TYPE-CD
000366           MOVE TRAN-TYPE-DESC TO TRAN-REPORT-TYPE-DESC
000367           MOVE TRAN-CAT-CD OF TRAN-RECORD  TO TRAN-REPORT-CAT-CD
000368           MOVE TRAN-CAT-TYPE-DESC TO TRAN-REPORT-CAT-DESC
000369           MOVE TRAN-SOURCE TO TRAN-REPORT-SOURCE
000370           MOVE TRAN-AMT TO TRAN-REPORT-AMT
```

### Cross-references

- **TRN-BR-006**: Transaction-domain perspective of this same report
- **TRN-BR-009**: Pipeline orchestration (CBTRN03C is step 3)
- **UC-TRN-06**: Use case for daily report generation

## Acceptance Criteria

### Scenario 1: Report generation within date range

```gherkin
GIVEN a date parameter file with start date "2026-01-01" and end date "2026-01-31"
  AND the TRANSACT file contains transactions with processing dates in January and December
WHEN the batch report program (CBTRN03C) runs
THEN only transactions with TRAN-PROC-TS between "2026-01-01" and "2026-01-31" are included
  AND transactions outside the date range are skipped without accumulating amounts
```

### Scenario 2: Account grouping with control-break totals

```gherkin
GIVEN transactions are sorted by card number in the TRANSACT file
  AND card "4000000000000001" has 3 transactions totaling +1,500.00
  AND card "4000000000000002" has 2 transactions totaling +800.00
WHEN the card number changes between consecutive records
THEN an account total line is written for card "4000000000000001" showing +1,500.00
  AND the account total resets to zero for the new card
```

### Scenario 3: Page totaling every 20 lines

```gherkin
GIVEN the report has generated 20 detail lines on the current page
WHEN the 21st detail line would be written
THEN a page total line is written with the sum of the 20 amounts
  AND the page total is added to the grand total
  AND new page headers are printed
  AND the page total and line count reset to zero
```

### Scenario 4: Grand total at end of report

```gherkin
GIVEN all transactions in the date range have been processed
WHEN the end of the TRANSACT file is reached
THEN the final page total is written
  AND the final account total is written for the last card group
  AND a grand total line is written
  AND Grand Total = Sum of all Page Totals
```

### Scenario 5: Lookup failure causes ABEND

```gherkin
GIVEN a transaction references card number "9999999999999999"
  AND this card does not exist in the CARDXREF file
WHEN the report program attempts the lookup
THEN the program ABENDs with error code 999
  AND report generation stops immediately
  AND an error message is displayed
```

### Scenario 6: Amount precision preserved

```gherkin
GIVEN transactions with amounts using S9(09)V99 precision
WHEN amounts are accumulated into page, account, and grand totals
THEN fixed-point addition is used (no rounding)
  AND detail amounts use format -ZZZ,ZZZ,ZZZ.ZZ
  AND total amounts use format +ZZZ,ZZZ,ZZZ.ZZ
```

## Regulatory Mapping

| Regulation | Article/Section | Requirement | How This Rule Satisfies It |
|---|---|---|---|
| FSA FFFS 2014:5 | Ch. 7 | Financial reporting and audit trail | Daily report provides complete transaction audit trail with multi-level totals |
| AML 2017:11 | Para. 3 | Transaction monitoring and reporting | Date-filtered report enables regulatory transaction review and feeds AML screening (RPT-BR-002) |
| DORA | Art. 11 | ICT risk management reporting | Deterministic error handling (ABEND on data quality issues) supports operational resilience |

## Edge Cases

1. **Final account total at EOF**: The COBOL card-change detection may not trigger for the last card group when EOF is reached. Lines 198-204 handle the final amounts, but the account total write may be missed. The migrated system must explicitly write the final account total after the main loop.

2. **Empty report (no transactions in range)**: If no transactions fall within the date range, the report is generated with headers and a grand total of zero. The migrated system should handle this gracefully with a "No transactions in period" message.

3. **Page size includes headers**: The 20-line page size (WS-PAGE-SIZE) may count header lines, reducing the effective detail lines per page. Domain expert clarification needed on whether 20 is the total line count or detail-only count.

4. **Report line width**: 133-character records (FD-REPTFILE-REC PIC X(133)) match mainframe 132-column print + 1 carriage control character. The migrated system should use equivalent formatting or provide configurable output width.

5. **NEXT SENTENCE semantics**: The date filter uses `NEXT SENTENCE` (line 177), which falls through to the next period terminator, not the next statement. The migrated system should use a simple `continue` — care needed to avoid translating `NEXT SENTENCE` as `break` or `return`.

## Domain Expert Notes

- **null** (null): Awaiting domain expert review. This rule captures the reporting-domain perspective of the daily transaction report. See TRN-BR-006 for the transaction-domain perspective with identical COBOL source. QUESTIONS: (1) Is the daily report the primary input for all other regulatory reports, or are there separate data sources? (2) Should the migrated system produce PDF, CSV, or both formats? (3) Is the 20-line page size a business requirement or a legacy printer constraint? (4) Should lookup failures be fatal (current behavior) or should the migrated system log and continue?

---

**Template version:** 1.0
**Last updated:** 2026-02-17
